{"version":3,"sources":["../../../src/passes/layers-pass.js"],"names":["LayersPass","Pass","render","params","gl","framebuffer","outputBuffer","drawLayers","layers","viewports","views","onViewportActive","deviceRect","parameters","pass","redrawReason","clearCanvas","effects","effectProps","renderStats","forEach","viewportOrDescriptor","i","viewport","getViewportFromDescriptor","view","id","stats","drawLayersInViewport","push","glViewport","getGLViewport","props","clear","clearOpts","color","depth","scissorTest","scissor","renderStatus","totalCount","length","visibleCount","compositeCount","pickableCount","layer","layerIndex","shouldDrawLayer","pickable","isComposite","drawLayerInViewport","moduleParameters","getModuleParameters","uniforms","Object","assign","context","layerParameters","getLayerParameters","drawLayer","layerFilter","visible","isPicking","create","pickingActive","devicePixelRatio","pixelRatio","height","canvas","clientHeight","dimensions","x","y","width","drawingBufferWidth","drawingBufferHeight"],"mappings":"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","sourcesContent":["import GL from '@luma.gl/constants';\nimport Pass from './pass';\nimport {clear, setParameters, withParameters} from '@luma.gl/core';\n\nexport default class LayersPass extends Pass {\n  render(params) {\n    const gl = this.gl;\n\n    return withParameters(gl, {framebuffer: params.outputBuffer}, () => this.drawLayers(params));\n  }\n\n  // PRIVATE\n  // Draw a list of layers in a list of viewports\n  drawLayers({\n    layers,\n    viewports,\n    views,\n    onViewportActive,\n    deviceRect = null,\n    parameters = {},\n    pass = 'draw',\n    redrawReason = '',\n    clearCanvas = true,\n    effects,\n    effectProps\n  }) {\n    const gl = this.gl;\n    if (clearCanvas) {\n      this.clearCanvas(gl);\n    }\n\n    const renderStats = [];\n\n    viewports.forEach((viewportOrDescriptor, i) => {\n      const viewport = this.getViewportFromDescriptor(viewportOrDescriptor);\n      const view = views && views[viewport.id];\n\n      // Update context to point to this viewport\n      onViewportActive(viewport);\n\n      // render this viewport\n      const stats = this.drawLayersInViewport(gl, {\n        layers,\n        viewport,\n        view,\n        deviceRect,\n        parameters,\n        pass,\n        redrawReason,\n        effects,\n        effectProps\n      });\n      renderStats.push(stats);\n    });\n    return renderStats;\n  }\n\n  // Draws a list of layers in one viewport\n  // TODO - when picking we could completely skip rendering viewports that dont\n  // intersect with the picking rect\n  drawLayersInViewport(\n    gl,\n    {\n      layers,\n      viewport,\n      view,\n      deviceRect = null,\n      parameters = {},\n      pass = 'draw',\n      redrawReason = '',\n      effects,\n      effectProps\n    }\n  ) {\n    const glViewport = this.getGLViewport(gl, {viewport});\n\n    if (view && view.props.clear) {\n      const clearOpts = view.props.clear === true ? {color: true, depth: true} : view.props.clear;\n      withParameters(\n        gl,\n        {\n          scissorTest: true,\n          scissor: glViewport\n        },\n        () => clear(gl, clearOpts)\n      );\n    }\n\n    // render layers in normal colors\n    const renderStatus = {\n      totalCount: layers.length,\n      visibleCount: 0,\n      compositeCount: 0,\n      pickableCount: 0\n    };\n\n    setParameters(gl, parameters || {});\n\n    // render layers in normal colors\n    layers.forEach((layer, layerIndex) => {\n      // Check if we should draw layer\n      const shouldDrawLayer = this.shouldDrawLayer(layer, viewport);\n\n      // Calculate stats\n      if (shouldDrawLayer && layer.props.pickable) {\n        renderStatus.pickableCount++;\n      }\n      if (layer.isComposite) {\n        renderStatus.compositeCount++;\n      }\n\n      // Draw the layer\n      if (shouldDrawLayer) {\n        renderStatus.visibleCount++;\n\n        this.drawLayerInViewport({\n          gl,\n          layer,\n          layerIndex,\n          glViewport,\n          parameters,\n          effects,\n          effectProps\n        });\n      }\n    });\n\n    return renderStatus;\n  }\n\n  drawLayerInViewport({gl, layer, layerIndex, glViewport, parameters, effects, effectProps}) {\n    const moduleParameters = this.getModuleParameters(layer, effects, effectProps);\n    const uniforms = Object.assign({}, layer.context.uniforms, {layerIndex});\n    const layerParameters = this.getLayerParameters(layer, layerIndex, glViewport, parameters);\n\n    layer.drawLayer({\n      moduleParameters,\n      uniforms,\n      parameters: layerParameters\n    });\n  }\n\n  // Get a viewport from a viewport descriptor (which can be a plain viewport)\n  getViewportFromDescriptor(viewportOrDescriptor) {\n    return viewportOrDescriptor.viewport ? viewportOrDescriptor.viewport : viewportOrDescriptor;\n  }\n\n  shouldDrawLayer(layer, viewport) {\n    const layerFilter = this.props.layerFilter;\n    let shouldDrawLayer = !layer.isComposite && layer.props.visible;\n\n    if (shouldDrawLayer && layerFilter) {\n      shouldDrawLayer = layerFilter({layer, viewport, isPicking: false});\n    }\n    return shouldDrawLayer;\n  }\n\n  getModuleParameters(layer) {\n    const moduleParameters = Object.assign(Object.create(layer.props), {\n      viewport: layer.context.viewport,\n      pickingActive: 0,\n      devicePixelRatio: this.props.pixelRatio\n    });\n    return moduleParameters;\n  }\n\n  getLayerParameters(layer, layerIndex, glViewport, parameters) {\n    // All parameter resolving is done here instead of the layer\n    // Blend parameters must not be overridden\n    const layerParameters = Object.assign({}, layer.props.parameters || {}, parameters);\n\n    Object.assign(layerParameters, {\n      viewport: glViewport\n    });\n    return layerParameters;\n  }\n\n  // Convert viewport top-left CSS coordinates to bottom up WebGL coordinates\n  getGLViewport(gl, {viewport}) {\n    // TODO - dummy default for node\n    // Fallback to width/height when clientWidth/clientHeight are 0 or undefined.\n    const height = gl.canvas ? gl.canvas.clientHeight || gl.canvas.height : 100;\n    // Convert viewport top-left CSS coordinates to bottom up WebGL coordinates\n    const dimensions = viewport;\n    const pixelRatio = this.props.pixelRatio;\n    return [\n      dimensions.x * pixelRatio,\n      (height - dimensions.y - dimensions.height) * pixelRatio,\n      dimensions.width * pixelRatio,\n      dimensions.height * pixelRatio\n    ];\n  }\n\n  clearCanvas(gl) {\n    const width = gl.drawingBufferWidth;\n    const height = gl.drawingBufferHeight;\n    // clear depth and color buffers, restoring transparency\n    withParameters(gl, {viewport: [0, 0, width, height]}, () => {\n      gl.clear(GL.COLOR_BUFFER_BIT | GL.DEPTH_BUFFER_BIT);\n    });\n  }\n}\n"],"file":"layers-pass.js"}