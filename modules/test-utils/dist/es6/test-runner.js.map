{"version":3,"sources":["../../src/test-runner.js"],"names":["Deck","MapView","GL_VENDOR","DEFAULT_DECK_PROPS","Object","assign","defaultProps","id","width","height","style","position","left","top","views","useDevicePixels","debug","DEFAULT_TEST_OPTIONS","onTestStart","testCase","console","log","name","onTestPass","onTestFail","timeout","DEFAULT_TEST_CASE","props","onAfterRender","done","TestRunner","constructor","isRunning","_testCases","_testCaseData","isHeadless","Boolean","window","browserTestDriver_isHeadless","testOptions","add","testCases","Array","isArray","push","run","options","Promise","resolve","reject","deck","onWebGLInitialized","_onWebGLInitialized","bind","onLoad","_currentTestCase","then","promise","forEach","_runTest","catch","error","_fail","message","finally","finalize","initTestCase","key","assert","_next","_pass","result","gl","vendorMasked","getParameter","ext","getExtension","vendorUnmasked","UNMASKED_VENDOR_WEBGL","gpuVendor","isDone","timeoutId","clearTimeout","setTimeout","setProps","layers","layerManager","getLayers"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\n/* global window, console */\n/* eslint-disable no-console */\nimport { Deck, MapView } from 'kepler-outdated-deck.gl-core';\n\nconst GL_VENDOR = 0x1f00;\n\nconst DEFAULT_DECK_PROPS = Object.assign({}, Deck.defaultProps, {\n  id: 'deckgl-render-test',\n  width: 800,\n  height: 450,\n  style: {position: 'absolute', left: '0px', top: '0px'},\n  views: [new MapView()],\n  useDevicePixels: false,\n  debug: true\n});\n\nconst DEFAULT_TEST_OPTIONS = {\n  // test lifecycle callback\n  onTestStart: testCase => console.log(`# ${testCase.name}`),\n  onTestPass: testCase => console.log(`ok ${testCase.name} passed`),\n  onTestFail: testCase => console.log(`not ok ${testCase.name} failed`),\n\n  // milliseconds to wait for each test case before aborting\n  timeout: 2000\n};\n\nconst DEFAULT_TEST_CASE = {\n  name: 'Unnamed test',\n  props: {},\n  onAfterRender: ({done}) => done()\n};\n\nexport default class TestRunner {\n  /**\n   * props\n   *   Deck props\n   */\n  constructor(props = {}) {\n    this.props = Object.assign({}, DEFAULT_DECK_PROPS, props);\n\n    this.isRunning = false;\n    this._testCases = [];\n    this._testCaseData = null;\n\n    this.isHeadless = Boolean(window.browserTestDriver_isHeadless);\n\n    this.testOptions = Object.assign({}, DEFAULT_TEST_OPTIONS);\n  }\n\n  /**\n   * Add testCase(s)\n   */\n  add(testCases) {\n    if (!Array.isArray(testCases)) {\n      testCases = [testCases];\n    }\n    for (const testCase of testCases) {\n      this._testCases.push(testCase);\n    }\n    return this;\n  }\n\n  /**\n   * Returns a promise that resolves when all the test cases are done\n   */\n  run(options = {}) {\n    Object.assign(this.testOptions, options);\n\n    return new Promise((resolve, reject) => {\n      this.deck = new Deck(\n        Object.assign({}, this.props, {\n          onWebGLInitialized: this._onWebGLInitialized.bind(this),\n          onLoad: resolve\n        })\n      );\n\n      this.isRunning = true;\n      this._currentTestCase = null;\n    })\n      .then(() => {\n        let promise = Promise.resolve();\n        // chain test case promises\n        this._testCases.forEach(testCase => {\n          promise = promise.then(() => this._runTest(testCase));\n        });\n        return promise;\n      })\n      .catch(error => {\n        this._fail({error: error.message});\n      })\n      .finally(() => {\n        this.deck.finalize();\n        this.deck = null;\n      });\n  }\n\n  /* Lifecycle methods for subclassing */\n\n  initTestCase(testCase) {\n    for (const key in DEFAULT_TEST_CASE) {\n      testCase[key] = testCase[key] || DEFAULT_TEST_CASE[key];\n    }\n    this.testOptions.onTestStart(testCase);\n  }\n\n  assert(testCase) {\n    this.onTestPass(testCase);\n    this._next();\n  }\n\n  /* Utilities */\n\n  _pass(result) {\n    this.testOptions.onTestPass(this._currentTestCase, result);\n  }\n\n  _fail(result) {\n    this.testOptions.onTestFail(this._currentTestCase, result);\n  }\n\n  /* Private Methods */\n\n  _onWebGLInitialized(gl) {\n    const vendorMasked = gl.getParameter(GL_VENDOR);\n    const ext = gl.getExtension('WEBGL_debug_renderer_info');\n    const vendorUnmasked = ext && gl.getParameter(ext.UNMASKED_VENDOR_WEBGL || GL_VENDOR);\n    this.gpuVendor = vendorUnmasked || vendorMasked;\n  }\n\n  _runTest(testCase) {\n    return new Promise((resolve, reject) => {\n      const {deck} = this;\n      this._currentTestCase = testCase;\n      this._next = resolve;\n\n      // normalize test case\n      this.initTestCase(testCase);\n\n      let isDone = false;\n      let timeoutId = null;\n      const done = () => {\n        if (!isDone) {\n          isDone = true;\n          window.clearTimeout(timeoutId);\n          this.assert(testCase);\n        }\n      };\n\n      timeoutId = window.setTimeout(done, testCase.timeout || this.testOptions.timeout);\n\n      deck.setProps(\n        Object.assign({}, this.props, testCase, {\n          onAfterRender: () => {\n            testCase.onAfterRender({\n              deck,\n              layers: deck.layerManager.getLayers(),\n              done\n            });\n          }\n        })\n      );\n    });\n  }\n}\n"],"file":"test-runner.js"}