{"version":3,"sources":["../../src/lifecycle-test.js"],"names":["testViewport","MapView","makeViewport","width","height","viewState","longitude","latitude","zoom","defaultOnError","error","title","safelyCall","func","onError","e","testInitializeLayer","layer","viewport","layerManager","LayerManager","gl","id","setLayers","testUpdateLayer","newProps","clone","testDrawLayer","uniforms","deckRenderer","DeckRenderer","renderLayers","viewports","layers","getLayers","activateViewport","testLayer","Layer","testCases","spies","initialProps","props","oldResourceCounts","getResourceCounts","runLayerTests","resourceCounts","resourceName","Error","resourceStats","luma","stats","get","Texture2D","count","Buffer","injectSpies","spyMap","functionName","Object","getPrototypeOf","combinedProps","i","testCase","updateProps","onBeforeUpdate","onAfterUpdate","assign","oldState","state","subLayers","isComposite","getSubLayers","subLayer","length","keys","forEach","k","reset"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport { LayerManager, MapView, DeckRenderer } from 'kepler-outdated-deck.gl-core';\n\nimport {makeSpy} from '@probe.gl/test-utils';\nimport gl from './utils/setup-gl';\n\nconst testViewport = new MapView().makeViewport({\n  width: 100,\n  height: 100,\n  viewState: {longitude: 0, latitude: 0, zoom: 1}\n});\n\nfunction defaultOnError(error, title) {\n  if (error) {\n    throw error;\n  }\n}\n\nfunction safelyCall(title, func, onError) {\n  let error = null;\n  try {\n    func();\n  } catch (e) {\n    error = e;\n  }\n  onError(error, title);\n}\n\nexport function testInitializeLayer({layer, viewport = testViewport, onError = defaultOnError}) {\n  const layerManager = new LayerManager(gl, {viewport});\n\n  safelyCall(`initializing ${layer.id}`, () => layerManager.setLayers([layer]), onError);\n\n  return null;\n}\n\nexport function testUpdateLayer({\n  layer,\n  viewport = testViewport,\n  newProps,\n  onError = defaultOnError\n}) {\n  const layerManager = new LayerManager(gl, {viewport});\n\n  safelyCall(\n    `updating ${layer.id}`,\n    () => {\n      layerManager.setLayers([layer]);\n      layerManager.setLayers([layer.clone(newProps)]);\n    },\n    onError\n  );\n\n  return null;\n}\n\nexport function testDrawLayer({\n  layer,\n  viewport = testViewport,\n  uniforms = {},\n  onError = defaultOnError\n}) {\n  const layerManager = new LayerManager(gl, {viewport});\n  const deckRenderer = new DeckRenderer(gl);\n\n  safelyCall(\n    `drawing ${layer.id}`,\n    () => {\n      layerManager.setLayers([layer]);\n      deckRenderer.renderLayers({\n        viewports: [testViewport],\n        layers: layerManager.getLayers(),\n        activateViewport: layerManager.activateViewport\n      });\n    },\n    onError\n  );\n\n  return null;\n}\n\nexport function testLayer({\n  Layer,\n  viewport = testViewport,\n  testCases = [],\n  spies = [],\n  onError = defaultOnError\n}) {\n  // assert(Layer);\n\n  const layerManager = new LayerManager(gl, {viewport});\n  const deckRenderer = new DeckRenderer(gl);\n\n  const initialProps = testCases[0].props;\n  const layer = new Layer(initialProps);\n\n  const oldResourceCounts = getResourceCounts();\n\n  safelyCall(`initializing ${layer.id}`, () => layerManager.setLayers([layer]), onError);\n\n  runLayerTests(layerManager, deckRenderer, layer, testCases, spies, onError);\n\n  safelyCall(`finalizing ${layer.id}`, () => layerManager.setLayers([]), onError);\n\n  const resourceCounts = getResourceCounts();\n\n  for (const resourceName in resourceCounts) {\n    if (resourceCounts[resourceName] !== oldResourceCounts[resourceName]) {\n      onError(\n        new Error(\n          `${resourceCounts[resourceName] - oldResourceCounts[resourceName]} ${resourceName}s`\n        ),\n        `${layer.id} should delete all ${resourceName}s`\n      );\n    }\n  }\n}\n\nfunction getResourceCounts() {\n  /* global luma */\n  const resourceStats = luma.stats.get('Resource Counts');\n  return {\n    Texture2D: resourceStats.get('Texture2Ds Active').count,\n    Buffer: resourceStats.get('Buffers Active').count\n  };\n}\n\nfunction injectSpies(layer, spies) {\n  const spyMap = {};\n  if (spies) {\n    for (const functionName of spies) {\n      spyMap[functionName] = makeSpy(Object.getPrototypeOf(layer), functionName);\n    }\n  }\n  return spyMap;\n}\n\n/* eslint-disable max-params, no-loop-func */\nfunction runLayerTests(layerManager, deckRenderer, layer, testCases, spies, onError) {\n  let combinedProps = {};\n\n  // Run successive update tests\n  for (let i = 0; i < testCases.length; i++) {\n    const testCase = testCases[i];\n    const {props, updateProps, onBeforeUpdate, onAfterUpdate} = testCase;\n\n    spies = testCase.spies || spies;\n\n    // Test case can reset the props on every iteration\n    if (props) {\n      combinedProps = Object.assign({}, props);\n    }\n    // Test case can override with new props on every iteration\n    if (updateProps) {\n      Object.assign(combinedProps, updateProps);\n    }\n\n    // copy old state before update\n    const oldState = Object.assign({}, layer.state);\n\n    if (onBeforeUpdate) {\n      onBeforeUpdate({layer, testCase});\n    }\n\n    layer = layer.clone(combinedProps);\n    // Create a map of spies that the test case can inspect\n    const spyMap = injectSpies(layer, spies);\n\n    safelyCall(`updating ${layer.id}`, () => layerManager.setLayers([layer]), onError);\n\n    // call draw layer\n    safelyCall(\n      `drawing ${layer.id}`,\n      () =>\n        deckRenderer.renderLayers({\n          viewports: [testViewport],\n          layers: layerManager.getLayers(),\n          activateViewport: layerManager.activateViewport\n        }),\n      onError\n    );\n\n    // layer manager should handle match subLayer and tranfer state and props\n    // here we assume subLayer matches copy over the new props from a new subLayer\n    const subLayers = layer.isComposite ? layer.getSubLayers() : [];\n    const subLayer = subLayers.length && subLayers[0];\n\n    // assert on updated layer\n    if (onAfterUpdate) {\n      onAfterUpdate({testCase, layer, oldState, subLayers, subLayer, spies: spyMap});\n    }\n\n    // Remove spies\n    Object.keys(spyMap).forEach(k => spyMap[k].reset());\n  }\n}\n/* eslint-enable parameters, no-loop-func */\n"],"file":"lifecycle-test.js"}