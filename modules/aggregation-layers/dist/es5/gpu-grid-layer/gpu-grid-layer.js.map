{"version":3,"sources":["../../../src/gpu-grid-layer/gpu-grid-layer.js"],"names":["defaultMaterial","PhongMaterial","defaultProps","colorDomain","colorRange","defaultColorRange","getColorWeight","type","value","x","colorAggregation","elevationDomain","elevationRange","getElevationWeight","elevationAggregation","elevationScale","min","cellSize","max","coverage","getPosition","position","extruded","fp64","material","gpuAggregation","GPUGridLayer","CompositeLayer","initializeState","gl","context","isSupported","GPUGridAggregator","log","error","options","id","shaderCache","state","gpuGridAggregator","updateState","opts","aggregationFlags","getAggregationFlags","getLayerData","setState","gridHash","finalizeState","delete","oldProps","props","changeFlags","isDataChanged","Object","assign","dataChanged","cellSizeChanged","updateTriggersChanged","all","getHashKeyForIndex","index","gridSize","gridOrigin","yIndex","Math","floor","xIndex","latIdx","lonIdx","getPositionForIndex","yPos","xPos","getPickingInfo","info","mode","object","colorInfo","getAggregationData","pixelIndex","getData","elevationInfo","colorValue","cellWeight","elevationValue","count","cellCount","totalCount","data","cpuAggregation","key","cpuAggregationData","picked","Boolean","cellSizeMeters","weightParams","color","getWeight","operation","AGGREGATION_OPERATION","needMin","needMax","combineMaxMin","elevation","weights","boundingBox","renderLayers","Float32Array","SubLayerClass","getSubLayerClass","GPUGridCellLayer","gridOffset","getSubLayerProps","numInstances","layerName"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport {PhongMaterial} from '@luma.gl/core';\nimport { CompositeLayer, log } from 'kepler-outdated-deck.gl-core';\n\nimport GPUGridAggregator from '../utils/gpu-grid-aggregation/gpu-grid-aggregator';\nimport {AGGREGATION_OPERATION} from '../utils/aggregation-operation-utils';\nimport {pointToDensityGridData} from '../utils/gpu-grid-aggregation/grid-aggregation-utils';\nimport {defaultColorRange, colorRangeToFlatArray} from '../utils/color-utils';\nimport GPUGridCellLayer from './gpu-grid-cell-layer';\nimport {pointToDensityGridDataCPU} from './../cpu-grid-layer/grid-aggregator';\n\nconst defaultMaterial = new PhongMaterial();\nconst defaultProps = {\n  // color\n  colorDomain: null,\n  colorRange: defaultColorRange,\n  getColorWeight: {type: 'accessor', value: x => 1},\n  colorAggregation: 'SUM',\n\n  // elevation\n  elevationDomain: null,\n  elevationRange: [0, 1000],\n  getElevationWeight: {type: 'accessor', value: x => 1},\n  elevationAggregation: 'SUM',\n  elevationScale: {type: 'number', min: 0, value: 1},\n\n  // grid\n  cellSize: {type: 'number', min: 0, max: 1000, value: 1000},\n  coverage: {type: 'number', min: 0, max: 1, value: 1},\n  getPosition: {type: 'accessor', value: x => x.position},\n  extruded: false,\n  fp64: false,\n\n  // Optional material for 'lighting' shader module\n  material: defaultMaterial,\n\n  // GPU Aggregation\n  gpuAggregation: true\n};\n\nexport default class GPUGridLayer extends CompositeLayer {\n  initializeState() {\n    const {gl} = this.context;\n    const isSupported = GPUGridAggregator.isSupported(gl);\n    if (!isSupported) {\n      log.error('GPUGridLayer is not supported on this browser, use GridLayer instead')();\n    }\n    const options = {\n      id: `${this.id}-gpu-aggregator`,\n      shaderCache: this.context.shaderCache\n    };\n    this.state = {\n      gpuGridAggregator: new GPUGridAggregator(gl, options),\n      isSupported\n    };\n  }\n\n  updateState(opts) {\n    const aggregationFlags = this.getAggregationFlags(opts);\n    if (aggregationFlags) {\n      // aggregate points into grid cells\n      this.getLayerData(aggregationFlags);\n      // reset cached CPU Aggregation results (used for picking)\n      this.setState({gridHash: null});\n    }\n  }\n\n  finalizeState() {\n    super.finalizeState();\n    this.state.gpuGridAggregator.delete();\n  }\n\n  getAggregationFlags({oldProps, props, changeFlags}) {\n    let aggregationFlags = null;\n    if (!this.state.isSupported) {\n      // Skip update, layer not supported\n      return false;\n    }\n    if (this.isDataChanged({oldProps, props, changeFlags})) {\n      aggregationFlags = Object.assign({}, aggregationFlags, {dataChanged: true});\n    }\n    if (oldProps.cellSize !== props.cellSize) {\n      aggregationFlags = Object.assign({}, aggregationFlags, {cellSizeChanged: true});\n    }\n    return aggregationFlags;\n  }\n\n  isDataChanged({oldProps, props, changeFlags}) {\n    // Flags affecting aggregation data\n    if (changeFlags.dataChanged) {\n      return true;\n    }\n    if (oldProps.gpuAggregation !== props.gpuAggregation) {\n      return true;\n    }\n    if (\n      oldProps.colorAggregation !== props.colorAggregation ||\n      oldProps.elevationAggregation !== props.elevationAggregation\n    ) {\n      return true;\n    }\n    if (\n      changeFlags.updateTriggersChanged &&\n      (changeFlags.updateTriggersChanged.all ||\n        changeFlags.updateTriggersChanged.getPosition ||\n        changeFlags.updateTriggersChanged.getColorWeight ||\n        changeFlags.updateTriggersChanged.getElevationWeight)\n    ) {\n      return true;\n    }\n    return false;\n  }\n\n  getHashKeyForIndex(index) {\n    const {gridSize, gridOrigin, cellSize} = this.state;\n    const yIndex = Math.floor(index / gridSize[0]);\n    const xIndex = index - yIndex * gridSize[0];\n    // This will match the index to the hash-key to access aggregation data from CPU aggregation results.\n    const latIdx = Math.floor(\n      (yIndex * cellSize[1] + gridOrigin[1] + 90 + cellSize[1] / 2) / cellSize[1]\n    );\n    const lonIdx = Math.floor(\n      (xIndex * cellSize[0] + gridOrigin[0] + 180 + cellSize[0] / 2) / cellSize[0]\n    );\n    return `${latIdx}-${lonIdx}`;\n  }\n\n  getPositionForIndex(index) {\n    const {gridSize, gridOrigin, cellSize} = this.state;\n    const yIndex = Math.floor(index / gridSize[0]);\n    const xIndex = index - yIndex * gridSize[0];\n    const yPos = yIndex * cellSize[1] + gridOrigin[1];\n    const xPos = xIndex * cellSize[0] + gridOrigin[0];\n    return [xPos, yPos];\n  }\n\n  getPickingInfo({info, mode}) {\n    const {index} = info;\n    let object = null;\n    if (index >= 0) {\n      const {gpuGridAggregator} = this.state;\n      const position = this.getPositionForIndex(index);\n      const colorInfo = GPUGridAggregator.getAggregationData(\n        Object.assign({pixelIndex: index}, gpuGridAggregator.getData('color'))\n      );\n      const elevationInfo = GPUGridAggregator.getAggregationData(\n        Object.assign({pixelIndex: index}, gpuGridAggregator.getData('elevation'))\n      );\n\n      object = {\n        colorValue: colorInfo.cellWeight,\n        elevationValue: elevationInfo.cellWeight,\n        count: colorInfo.cellCount || elevationInfo.cellCount,\n        position,\n        totalCount: colorInfo.totalCount || elevationInfo.totalCount\n      };\n      if (mode !== 'hover') {\n        // perform CPU aggregation for full list of points for each cell\n        const {data, getPosition} = this.props;\n        let {gridHash} = this.state;\n        if (!gridHash) {\n          const cpuAggregation = pointToDensityGridDataCPU(data, this.props.cellSize, getPosition);\n          gridHash = cpuAggregation.gridHash;\n          this.setState({gridHash});\n        }\n        const key = this.getHashKeyForIndex(index);\n        const cpuAggregationData = gridHash[key];\n        Object.assign(object, cpuAggregationData);\n      }\n    }\n\n    return Object.assign(info, {\n      picked: Boolean(object),\n      // override object with picked cell\n      object\n    });\n  }\n\n  getLayerData(aggregationFlags) {\n    const {\n      data,\n      cellSize: cellSizeMeters,\n      getPosition,\n      gpuAggregation,\n      getColorWeight,\n      colorAggregation,\n      getElevationWeight,\n      elevationAggregation,\n      fp64\n    } = this.props;\n    const weightParams = {\n      color: {\n        getWeight: getColorWeight,\n        operation:\n          AGGREGATION_OPERATION[colorAggregation] ||\n          AGGREGATION_OPERATION[defaultProps.colorAggregation],\n        needMin: true,\n        needMax: true,\n        combineMaxMin: true\n      },\n      elevation: {\n        getWeight: getElevationWeight,\n        operation:\n          AGGREGATION_OPERATION[elevationAggregation] ||\n          AGGREGATION_OPERATION[defaultProps.elevationAggregation],\n        needMin: true,\n        needMax: true,\n        combineMaxMin: true\n      }\n    };\n    const {weights, gridSize, gridOrigin, cellSize, boundingBox} = pointToDensityGridData({\n      data,\n      cellSizeMeters,\n      getPosition,\n      weightParams,\n      gpuAggregation,\n      gpuGridAggregator: this.state.gpuGridAggregator,\n      boundingBox: this.state.boundingBox, // avoid parsing data when it is not changed.\n      aggregationFlags,\n      fp64\n    });\n    this.setState({weights, gridSize, gridOrigin, cellSize, boundingBox});\n  }\n\n  renderLayers() {\n    if (!this.state.isSupported) {\n      return null;\n    }\n    const {\n      elevationScale,\n      fp64,\n      extruded,\n      cellSize: cellSizeMeters,\n      coverage,\n      material,\n      elevationRange,\n      colorDomain,\n      elevationDomain\n    } = this.props;\n\n    const {weights, gridSize, gridOrigin, cellSize} = this.state;\n\n    const colorRange = colorRangeToFlatArray(this.props.colorRange, Float32Array, 255);\n\n    const SubLayerClass = this.getSubLayerClass('gpu-grid-cell', GPUGridCellLayer);\n\n    return new SubLayerClass(\n      {\n        gridSize,\n        gridOrigin,\n        gridOffset: cellSize,\n        colorRange,\n        elevationRange,\n        colorDomain,\n        elevationDomain,\n\n        fp64,\n        cellSize: cellSizeMeters,\n        coverage,\n        material,\n        elevationScale,\n        extruded\n      },\n      this.getSubLayerProps({\n        id: 'gpu-grid-cell'\n      }),\n      {\n        data: weights,\n        numInstances: gridSize[0] * gridSize[1]\n      }\n    );\n  }\n}\n\nGPUGridLayer.layerName = 'GPUGridLayer';\nGPUGridLayer.defaultProps = defaultProps;\n"],"file":"gpu-grid-layer.js"}