{"version":3,"sources":["../../../src/hexagon-layer/hexagon-layer.js"],"names":["nop","defaultMaterial","PhongMaterial","defaultProps","colorDomain","colorRange","defaultColorRange","getColorValue","type","value","getColorWeight","x","colorAggregation","lowerPercentile","min","max","upperPercentile","onSetColorDomain","elevationDomain","elevationRange","getElevationValue","getElevationWeight","elevationAggregation","elevationLowerPercentile","elevationUpperPercentile","elevationScale","onSetElevationDomain","radius","coverage","extruded","hexagonAggregator","pointToHexbin","getPosition","position","fp64","material","COLOR_PROPS","ELEVATION_PROPS","HexagonLayer","CompositeLayer","initializeState","state","hexagons","sortedColorBins","sortedElevationBins","colorValueDomain","elevationValueDomain","colorScaleFunc","elevationScaleFunc","dimensionUpdaters","getDimensionUpdaters","updateState","oldProps","props","changeFlags","updateGetValueFuncs","dimensionChanges","getDimensionChanges","dataChanged","needsReProjectPoints","getHexagons","forEach","f","apply","colorElevationPropsChanged","colorChanged","elevationChanged","p","setState","getFillColor","id","triggers","updater","getSortedColorBins","getColorValueDomain","getColorScale","getElevation","getSortedElevationBins","getElevationValueDomain","getElevationScale","updaters","dimensionKey","needUpdate","find","item","some","t","push","length","viewport","context","hexagonVertices","updateRadiusAngle","getSortedBins","getPickingInfo","info","isPicked","picked","index","object","cell","colorValue","binMap","elevationValue","Object","assign","Boolean","getUpdateTriggers","updateTriggers","step","prop","vertices","angle","Array","isArray","log","error","vertex0","vertex3","pixelsPerMeter","getDistanceScales","spaceCoord0","projectFlat","spaceCoord3","dx","dy","dxy","Math","sqrt","acos","sign","PI","getValueDomain","BinSorter","warn","getValueRange","_onGetSublayerColor","cv","isColorValueInDomain","color","Number","isFinite","_onGetSublayerElevation","ev","isElevationValueInDomain","renderLayers","transitions","SubLayerClass","getSubLayerClass","ColumnLayer","diskResolution","bind","getSubLayerProps","data","layerName"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\nimport { PhongMaterial } from 'kepler-outdated-luma.gl-core';\nimport { CompositeLayer, log } from 'kepler-outdated-deck.gl-core';\nimport { ColumnLayer } from 'kepler-outdated-deck.gl-layers';\n\nimport BinSorter from '../utils/bin-sorter';\nimport {defaultColorRange} from '../utils/color-utils';\nimport {getQuantizeScale, getLinearScale} from '../utils/scale-utils';\nimport {getValueFunc} from '../utils/aggregation-operation-utils';\n\nimport {pointToHexbin} from './hexagon-aggregator';\n\nfunction nop() {}\n\nconst defaultMaterial = new PhongMaterial();\n\nconst defaultProps = {\n  // color\n  colorDomain: null,\n  colorRange: defaultColorRange,\n  getColorValue: {type: 'accessor', value: null}, // default value is calcuated from `getColorWeight` and `colorAggregation`\n  getColorWeight: {type: 'accessor', value: x => 1},\n  colorAggregation: 'SUM',\n  lowerPercentile: {type: 'number', value: 0, min: 0, max: 100},\n  upperPercentile: {type: 'number', value: 100, min: 0, max: 100},\n  onSetColorDomain: nop,\n\n  // elevation\n  elevationDomain: null,\n  elevationRange: [0, 1000],\n  getElevationValue: {type: 'accessor', value: null}, // default value is calcuated from `getElevationWeight` and `elevationAggregation`\n  getElevationWeight: {type: 'accessor', value: x => 1},\n  elevationAggregation: 'SUM',\n  elevationLowerPercentile: {type: 'number', value: 0, min: 0, max: 100},\n  elevationUpperPercentile: {type: 'number', value: 100, min: 0, max: 100},\n  elevationScale: {type: 'number', min: 0, value: 1},\n  onSetElevationDomain: nop,\n\n  radius: {type: 'number', value: 1000, min: 1},\n  coverage: {type: 'number', min: 0, max: 1, value: 1},\n  extruded: false,\n  hexagonAggregator: pointToHexbin,\n  getPosition: {type: 'accessor', value: x => x.position},\n  fp64: false,\n  // Optional material for 'lighting' shader module\n  material: defaultMaterial\n};\n\nconst COLOR_PROPS = ['getColorValue', 'colorAggregation', 'getColorWeight'];\nconst ELEVATION_PROPS = ['getElevationValue', 'elevationAggregation', 'getElevationWeight'];\n\nexport default class HexagonLayer extends CompositeLayer {\n  initializeState() {\n    this.state = {\n      hexagons: [],\n      sortedColorBins: null,\n      sortedElevationBins: null,\n      colorValueDomain: null,\n      elevationValueDomain: null,\n      colorScaleFunc: nop,\n      elevationScaleFunc: nop,\n      dimensionUpdaters: this.getDimensionUpdaters()\n    };\n  }\n\n  updateState({oldProps, props, changeFlags}) {\n    this.updateGetValueFuncs(oldProps, props);\n    const dimensionChanges = this.getDimensionChanges(oldProps, props);\n\n    if (changeFlags.dataChanged || this.needsReProjectPoints(oldProps, props)) {\n      // project data into hexagons, and get sortedColorBins\n      this.getHexagons();\n    } else if (dimensionChanges) {\n      dimensionChanges.forEach(f => typeof f === 'function' && f.apply(this));\n    }\n  }\n\n  colorElevationPropsChanged(oldProps, props) {\n    let colorChanged = false;\n    let elevationChanged = false;\n    for (const p of COLOR_PROPS) {\n      if (oldProps[p] !== props[p]) {\n        colorChanged = true;\n      }\n    }\n    for (const p of ELEVATION_PROPS) {\n      if (oldProps[p] !== props[p]) {\n        elevationChanged = true;\n      }\n    }\n    return {colorChanged, elevationChanged};\n  }\n\n  updateGetValueFuncs(oldProps, props) {\n    let {getColorValue, getElevationValue} = props;\n    const {colorAggregation, getColorWeight, elevationAggregation, getElevationWeight} = this.props;\n    const {colorChanged, elevationChanged} = this.colorElevationPropsChanged(oldProps, props);\n\n    if (colorChanged && getColorValue === null) {\n      // If `getColorValue` is not provided, build it.\n      getColorValue = getValueFunc(colorAggregation, getColorWeight);\n    }\n    if (elevationChanged && getElevationValue === null) {\n      // If `getElevationValue` is not provided, build it.\n      getElevationValue = getValueFunc(elevationAggregation, getElevationWeight);\n    }\n    if (getColorValue) {\n      this.setState({getColorValue});\n    }\n    if (getElevationValue) {\n      this.setState({getElevationValue});\n    }\n  }\n\n  needsReProjectPoints(oldProps, props) {\n    return (\n      oldProps.radius !== props.radius || oldProps.hexagonAggregator !== props.hexagonAggregator\n    );\n  }\n\n  getDimensionUpdaters() {\n    // dimension updaters are sequential,\n    // if the first one needs to be called, the 2nd and 3rd one will automatically\n    // be called. e.g. if ColorValue needs to be updated, getColorValueDomain and getColorScale\n    // will automatically be called\n    return {\n      getFillColor: [\n        {\n          id: 'value',\n          triggers: ['getColorValue', 'getColorWeight', 'colorAggregation'],\n          updater: this.getSortedColorBins\n        },\n        {\n          id: 'domain',\n          triggers: ['lowerPercentile', 'upperPercentile'],\n          updater: this.getColorValueDomain\n        },\n        {\n          id: 'scaleFunc',\n          triggers: ['colorDomain', 'colorRange'],\n          updater: this.getColorScale\n        }\n      ],\n      getElevation: [\n        {\n          id: 'value',\n          triggers: ['getElevationValue', 'getElevationWeight', 'elevationAggregation'],\n          updater: this.getSortedElevationBins\n        },\n        {\n          id: 'domain',\n          triggers: ['elevationLowerPercentile', 'elevationUpperPercentile'],\n          updater: this.getElevationValueDomain\n        },\n        {\n          id: 'scaleFunc',\n          triggers: ['elevationDomain', 'elevationRange'],\n          updater: this.getElevationScale\n        }\n      ]\n    };\n  }\n\n  getDimensionChanges(oldProps, props) {\n    const {dimensionUpdaters} = this.state;\n    const updaters = [];\n\n    // get dimension to be updated\n    for (const dimensionKey in dimensionUpdaters) {\n      // return the first triggered updater for each dimension\n      const needUpdate = dimensionUpdaters[dimensionKey].find(item =>\n        item.triggers.some(t => oldProps[t] !== props[t])\n      );\n\n      if (needUpdate) {\n        updaters.push(needUpdate.updater);\n      }\n    }\n\n    return updaters.length ? updaters : null;\n  }\n\n  getHexagons() {\n    const {hexagonAggregator} = this.props;\n    const {viewport} = this.context;\n    const {hexagons, hexagonVertices} = hexagonAggregator(this.props, viewport);\n    this.updateRadiusAngle(hexagonVertices);\n    this.setState({hexagons});\n    this.getSortedBins();\n  }\n\n  getPickingInfo({info}) {\n    const {sortedColorBins, sortedElevationBins} = this.state;\n    const isPicked = info.picked && info.index > -1;\n\n    let object = null;\n    if (isPicked) {\n      const cell = this.state.hexagons[info.index];\n\n      const colorValue =\n        sortedColorBins.binMap[cell.index] && sortedColorBins.binMap[cell.index].value;\n      const elevationValue =\n        sortedElevationBins.binMap[cell.index] && sortedElevationBins.binMap[cell.index].value;\n\n      object = Object.assign(\n        {\n          colorValue,\n          elevationValue\n        },\n        cell\n      );\n    }\n\n    // add bin colorValue and elevationValue to info\n    return Object.assign(info, {\n      picked: Boolean(object),\n      // override object with picked cell\n      object\n    });\n  }\n\n  getUpdateTriggers() {\n    const {dimensionUpdaters} = this.state;\n\n    // merge all dimension triggers\n    const updateTriggers = {};\n\n    for (const dimensionKey in dimensionUpdaters) {\n      updateTriggers[dimensionKey] = {};\n\n      for (const step of dimensionUpdaters[dimensionKey]) {\n        step.triggers.forEach(prop => {\n          updateTriggers[dimensionKey][prop] = this.props[prop];\n        });\n      }\n    }\n\n    return updateTriggers;\n  }\n\n  updateRadiusAngle(vertices) {\n    let {radius} = this.props;\n    let angle = 90;\n\n    if (Array.isArray(vertices)) {\n      if (vertices.length < 6) {\n        log.error('HexagonCellLayer: hexagonVertices needs to be an array of 6 points')();\n      }\n\n      // calculate angle and vertices from hexagonVertices if provided\n      const vertex0 = vertices[0];\n      const vertex3 = vertices[3];\n\n      // transform to space coordinates\n      const {viewport} = this.context;\n      const {pixelsPerMeter} = viewport.getDistanceScales();\n      const spaceCoord0 = this.projectFlat(vertex0);\n      const spaceCoord3 = this.projectFlat(vertex3);\n\n      // distance between two close centroids\n      const dx = spaceCoord0[0] - spaceCoord3[0];\n      const dy = spaceCoord0[1] - spaceCoord3[1];\n      const dxy = Math.sqrt(dx * dx + dy * dy);\n\n      // Calculate angle that the perpendicular hexagon vertex axis is tilted\n      angle = ((Math.acos(dx / dxy) * -Math.sign(dy)) / Math.PI) * 180 + 90;\n      radius = dxy / 2 / pixelsPerMeter[0];\n    }\n\n    this.setState({angle, radius});\n  }\n\n  getValueDomain() {\n    this.getColorValueDomain();\n    this.getElevationValueDomain();\n  }\n\n  getSortedBins() {\n    this.getSortedColorBins();\n    this.getSortedElevationBins();\n  }\n\n  getSortedColorBins() {\n    const {getColorValue} = this.state;\n    const sortedColorBins = new BinSorter(this.state.hexagons || [], getColorValue);\n\n    this.setState({sortedColorBins});\n    this.getColorValueDomain();\n  }\n\n  getSortedElevationBins() {\n    const {getElevationValue} = this.state;\n    const sortedElevationBins = new BinSorter(this.state.hexagons || [], getElevationValue);\n    this.setState({sortedElevationBins});\n    this.getElevationValueDomain();\n  }\n\n  getColorValueDomain() {\n    const {lowerPercentile, upperPercentile, onSetColorDomain} = this.props;\n\n    if (lowerPercentile > upperPercentile) {\n      log.warn('HexagonLayer: lowerPercentile is bigger than upperPercentile')();\n    }\n\n    this.state.colorValueDomain = this.state.sortedColorBins.getValueRange([\n      lowerPercentile,\n      upperPercentile\n    ]);\n\n    if (typeof onSetColorDomain === 'function') {\n      onSetColorDomain(this.state.colorValueDomain);\n    }\n\n    this.getColorScale();\n  }\n\n  getElevationValueDomain() {\n    const {elevationLowerPercentile, elevationUpperPercentile, onSetElevationDomain} = this.props;\n\n    this.state.elevationValueDomain = this.state.sortedElevationBins.getValueRange([\n      elevationLowerPercentile,\n      elevationUpperPercentile\n    ]);\n\n    if (typeof onSetElevationDomain === 'function') {\n      onSetElevationDomain(this.state.elevationValueDomain);\n    }\n\n    this.getElevationScale();\n  }\n\n  getColorScale() {\n    const {colorRange} = this.props;\n    const colorDomain = this.props.colorDomain || this.state.colorValueDomain;\n\n    this.state.colorScaleFunc = getQuantizeScale(colorDomain, colorRange);\n  }\n\n  getElevationScale() {\n    const {elevationRange} = this.props;\n    const elevationDomain = this.props.elevationDomain || this.state.elevationValueDomain;\n\n    this.state.elevationScaleFunc = getLinearScale(elevationDomain, elevationRange);\n  }\n\n  _onGetSublayerColor(cell) {\n    const {sortedColorBins, colorScaleFunc, colorValueDomain} = this.state;\n\n    const cv = sortedColorBins.binMap[cell.index] && sortedColorBins.binMap[cell.index].value;\n    const colorDomain = this.props.colorDomain || colorValueDomain;\n\n    const isColorValueInDomain = cv >= colorDomain[0] && cv <= colorDomain[colorDomain.length - 1];\n\n    // if cell value is outside domain, set alpha to 0\n    const color = isColorValueInDomain ? colorScaleFunc(cv) : [0, 0, 0, 0];\n\n    // add alpha to color if not defined in colorRange\n    color[3] = Number.isFinite(color[3]) ? color[3] : 255;\n\n    return color;\n  }\n\n  _onGetSublayerElevation(cell) {\n    const {sortedElevationBins, elevationScaleFunc, elevationValueDomain} = this.state;\n    const ev =\n      sortedElevationBins.binMap[cell.index] && sortedElevationBins.binMap[cell.index].value;\n\n    const elevationDomain = this.props.elevationDomain || elevationValueDomain;\n\n    const isElevationValueInDomain =\n      ev >= elevationDomain[0] && ev <= elevationDomain[elevationDomain.length - 1];\n\n    // if cell value is outside domain, set elevation to -1\n    return isElevationValueInDomain ? elevationScaleFunc(ev) : -1;\n  }\n\n  renderLayers() {\n    const {elevationScale, extruded, coverage, material, fp64, transitions} = this.props;\n    const {angle, radius} = this.state;\n\n    const SubLayerClass = this.getSubLayerClass('hexagon-cell', ColumnLayer);\n\n    return new SubLayerClass(\n      {\n        fp64,\n        radius,\n        diskResolution: 6,\n        elevationScale,\n        angle,\n        extruded,\n        coverage,\n        material,\n\n        getFillColor: this._onGetSublayerColor.bind(this),\n        getElevation: this._onGetSublayerElevation.bind(this),\n        transitions: transitions && {\n          getFillColor: transitions.getColorValue || transitions.getColorWeight,\n          getElevation: transitions.getElevationValue || transitions.getElevationWeight\n        }\n      },\n      this.getSubLayerProps({\n        id: 'hexagon-cell',\n        updateTriggers: this.getUpdateTriggers()\n      }),\n      {\n        data: this.state.hexagons\n      }\n    );\n  }\n}\n\nHexagonLayer.layerName = 'HexagonLayer';\nHexagonLayer.defaultProps = defaultProps;\n"],"file":"hexagon-layer.js"}